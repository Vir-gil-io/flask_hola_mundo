<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Buscador de Lugares</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  </head>

  <body class="bg-green-50 min-h-screen">
    <!-- CONTENEDOR PRINCIPAL -->
    <div class="max-w-7xl mx-auto px-6 py-6">
      <h1 class="text-4xl font-bold text-green-700 text-center mb-8">
        üåç Buscador de Lugares
      </h1>

      <!-- BUSCADOR -->
      <div class="relative max-w-4xl mx-auto mb-6 z-50">
        <form method="POST" autocomplete="off">
          <div class="flex gap-2">
            <input
              type="text"
              name="lugar"
              id="searchInput"
              placeholder="Ej. Par√≠s, M√©xico"
              value="{{ query }}"
              required
              class="flex-1 border-2 border-green-500 rounded-lg px-4 py-3 text-lg focus:outline-none"
            />
            <button
              type="submit"
              class="bg-green-600 text-white px-6 py-3 rounded-lg text-lg hover:bg-green-700 transition"
            >
              Buscar
            </button>
          </div>
        </form>

        <!-- SUGERENCIAS -->
        <ul
          id="suggestions"
          class="absolute w-full bg-white border rounded-lg mt-1 shadow-xl hidden z-[100]"
        ></ul>
      </div>

      {% if error %}
      <div
        class="bg-red-100 text-red-700 p-3 rounded-lg max-w-4xl mx-auto mb-6"
      >
        ‚ùå No se encontraron resultados
      </div>
      {% endif %} {% if lugares %}
      <!-- T√çTULO DEL RESULTADO -->
      <h2 class="text-2xl font-semibold text-gray-700 text-center mb-4">
        {{ lugares[0].nombre }}
      </h2>

      <!-- MAPA -->
      <div id="map" class="h-[600px] rounded-xl shadow-lg relative z-0"></div>

      <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
      <script>
        const lugares = {{ lugares | tojson }};

        const map = L.map('map').setView(
          [lugares[0].lat, lugares[0].lon],
          6
        );

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: 'OpenStreetMap'
        }).addTo(map);

        const bounds = [];

        lugares.forEach(lugar => {
          bounds.push([lugar.lat, lugar.lon]);

          L.marker([lugar.lat, lugar.lon])
            .addTo(map)
            .bindPopup(lugar.nombre);
        });

        map.fitBounds(bounds, { padding: [50, 50] });
      </script>
      {% endif %}
    </div>

    <!-- SUGERENCIAS EN TIEMPO REAL -->
    <script>
      const input = document.getElementById("searchInput");
      const suggestionsBox = document.getElementById("suggestions");

      input.addEventListener("input", async () => {
        const query = input.value.trim();

        if (query.length < 0) {
          suggestionsBox.classList.add("hidden");
          return;
        }

        const response = await fetch(
          `https://nominatim.openstreetmap.org/search?format=json&q=${query}&limit=20`,
        );
        const data = await response.json();

        suggestionsBox.innerHTML = "";

        data.forEach((item) => {
          const li = document.createElement("li");
          li.textContent = item.display_name;
          li.className = "px-4 py-2 hover:bg-green-100 cursor-pointer";

          li.onclick = () => {
            input.value = item.display_name;
            suggestionsBox.classList.add("hidden");

            //Enviar el formulario autom√°ticamente al seleccionar una sugerencia
            setTimeout(() => {
              input.closest("form").submit();
            }, 150);
          };

          suggestionsBox.appendChild(li);
        });

        suggestionsBox.classList.remove("hidden");
      });

      document.addEventListener("click", (e) => {
        if (!suggestionsBox.contains(e.target) && e.target !== input) {
          suggestionsBox.classList.add("hidden");
        }
      });
    </script>
  </body>
</html>
